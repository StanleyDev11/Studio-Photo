<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Réservations - Studio Photo Admin</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css">
    <style>
        :root {
            --primary-color: #4567b7;
            --primary-dark: #3455a0;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --gray-light: #ecf0f1;
            --shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: var(--dark-color);
            overflow-x: hidden;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            color: white;
            text-decoration: none;
        }

        .logo-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 80px;
            height: 80px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .nav-links {
            padding: 20px 0;
        }

        .nav-links li {
            list-style: none;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-links a:hover, .nav-links a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: white;
        }

        .nav-links i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 0;
            transition: var(--transition);
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
        }

        .search-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(69, 103, 183, 0.15);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }

        .user-details {
            margin-right: 20px;
        }

        .user-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .user-role {
            font-size: 13px;
            color: #7f8c8d;
        }

        /* Content Wrapper */
        .content-wrapper {
            padding: 30px;
        }

        .page-header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid var(--primary-color);
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-color);
            margin: 0;
        }

        .page-header h1 i {
            color: var(--primary-color);
            margin-right: 15px;
        }

        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 24px;
            color: white;
        }

        .total-bookings .stat-icon { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
        .pending-bookings .stat-icon { background: linear-gradient(135deg, var(--warning-color), #e67e22); }
        .confirmed-bookings .stat-icon { background: linear-gradient(135deg, var(--success-color), #27ae60); }
        .today-bookings .stat-icon { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark-color);
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--dark-color);
            display: block;
        }

        /* View Toggle */
        .view-toggle {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .view-buttons {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid #eee;
            border-radius: 8px;
            background: white;
            color: var(--dark-color);
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-btn:hover, .view-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Calendar View */
        #calendarView {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            display: none;
        }

        #calendar {
            height: 600px;
        }

        /* DataTable Customization */
        .dataTables_wrapper {
            background: white;
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .dataTables_length, .dataTables_filter {
            padding: 20px 20px 0;
        }

        .dataTables_info, .dataTables_paginate {
            padding: 20px;
        }

        #bookingsTable {
            margin: 0 !important;
        }

        #bookingsTable thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: var(--dark-color);
            padding: 15px 20px;
            white-space: nowrap;
        }

        #bookingsTable tbody td {
            padding: 15px 20px;
            vertical-align: middle;
            border-top: 1px solid #eee;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-pending {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .badge-confirmed {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(46, 204, 113, 0.2);
        }

        .badge-cancelled {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .badge-completed {
            background-color: rgba(149, 165, 166, 0.1);
            color: #95a5a6;
            border: 1px solid rgba(149, 165, 166, 0.2);
        }

        /* Customer Info */
        .customer-info {
            display: flex;
            align-items: center;
        }

        .customer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 10px;
        }

        /* Buttons */
        .btn-add-booking {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-weight: 600;
            font-size: 15px;
            box-shadow: 0 4px 15px rgba(69, 103, 183, 0.3);
            transition: var(--transition);
        }

        .btn-add-booking:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(69, 103, 183, 0.4);
        }

        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .quick-action-btn {
            background: #f8f9fa;
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: var(--transition);
            color: var(--dark-color);
            text-decoration: none;
            display: block;
        }

        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .quick-action-btn i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid var(--gray-light);
            background: white;
            margin-top: 30px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }

            .sidebar:hover {
                width: 250px;
            }

            .logo-text, .nav-links span {
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .sidebar:hover .logo-text,
            .sidebar:hover .nav-links span {
                opacity: 1;
            }

            .main-content {
                margin-left: 70px;
            }

            .sidebar:hover ~ .main-content {
                margin-left: 250px;
            }
        }

        @media (max-width: 992px) {
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                min-width: 100%;
            }

            .quick-actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
                margin-bottom: 15px;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .table-actions {
                flex-direction: column;
                gap: 5px;
            }

            .quick-actions-grid {
                grid-template-columns: 1fr;
            }

            .view-buttons {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 576px) {
            .content-wrapper {
                padding: 20px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .page-header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<!-- Sidebar Navigation -->
<nav class="sidebar">
    <div class="sidebar-header">
        <a href="/admin/dashboard" class="logo">
            <div class="logo-icon">
                <img th:src="@{/images/logo.jpeg}" alt="Picon Studio Photo Logo" style="width: 100%; height: auto; border-radius: 10px;">
            </div>
            <div class="logo-text">Picon Studio</div>
        </a>
    </div>
    <ul class="nav-links">
        <li><a href="/admin/dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
        <li><a href="/admin/users"><i class="fas fa-user-friends"></i><span>Utilisateurs</span></a></li>
        <li><a href="/admin/promotions"><i class="fas fa-bullhorn"></i><span>Promotions</span></a></li>
        <li><a href="/admin/dimensions"><i class="fas fa-ruler-combined"></i><span>Dimensions</span></a></li>
        <li><a href="/admin/featured-content"><i class="fas fa-star"></i><span>Contenu Mis en Avant</span></a></li>
        <li><a href="/admin/bookings" class="active"><i class="fas fa-calendar-check"></i><span>Réservations</span></a></li>
        <li><a href="#"><i class="fas fa-photo-video"></i><span>Photos</span></a></li>
        <li><a href="#"><i class="fas fa-shopping-basket"></i><span>Commandes</span></a></li>
        <li><a href="#"><i class="fas fa-calendar-alt"></i><span>Rendez-vous</span></a></li>
                    <li><a href="#"><i class="fas fa-chart-line"></i><span>Statistiques</span></a></li>
                    <li><a href="#"><i class="fas fa-cog"></i><span>Paramètres</span></a></li>
                    <li><a href="/admin/contact-info"><i class="fas fa-address-book"></i><span>Infos Contact</span></a></li>    </ul>
</nav>

<!-- Main Content -->
<div class="main-content">
    <!-- Top Bar -->
    <header class="top-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Rechercher réservations...">
        </div>
        <div class="user-info">
            <div class="user-details">
                <div class="user-name" th:text="${#authentication.principal.firstname + ' ' + #authentication.principal.lastname}"></div>
                <div class="user-role" sec:authentication="principal.authorities"></div>
            </div>
            <div class="user-avatar" id="userInitials"></div>
            <form th:action="@{/admin/logout}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </form>
        </div>
    </header>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-calendar-check"></i>Gestion des Réservations</h1>
            <button class="btn btn-add-booking" data-toggle="modal" data-target="#bookingModal" id="addBookingBtn">
                <i class="fas fa-plus-circle mr-2"></i>Nouvelle Réservation
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card total-bookings">
                <div class="stat-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalBookings">0</div>
                    <div class="stat-label">Total Réservations</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up mr-1"></i> 18% ce mois
                    </div>
                </div>
            </div>
            <div class="stat-card pending-bookings">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="pendingBookings">0</div>
                    <div class="stat-label">En Attente</div>
                    <div class="stat-change negative">
                        <i class="fas fa-arrow-down mr-1"></i> 5% ce mois
                    </div>
                </div>
            </div>
            <div class="stat-card confirmed-bookings">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="confirmedBookings">0</div>
                    <div class="stat-label">Confirmées</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up mr-1"></i> 22% ce mois
                    </div>
                </div>
            </div>
            <div class="stat-card today-bookings">
                <div class="stat-icon">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="todayBookings">0</div>
                    <div class="stat-label">Aujourd'hui</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up mr-1"></i> 15% vs hier
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-actions-grid">
                <a href="#" class="quick-action-btn" data-status="PENDING">
                    <i class="fas fa-clock text-warning"></i>
                    <div>Voir les en attente</div>
                </a>
                <a href="#" class="quick-action-btn" data-status="TODAY">
                    <i class="fas fa-calendar-day text-primary"></i>
                    <div>Réservations d'aujourd'hui</div>
                </a>
                <a href="#" class="quick-action-btn" data-action="export">
                    <i class="fas fa-file-export text-success"></i>
                    <div>Exporter les données</div>
                </a>
                <a href="#" class="quick-action-btn" data-action="calendar">
                    <i class="fas fa-calendar text-info"></i>
                    <div>Voir le calendrier</div>
                </a>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <div class="view-buttons">
                <button class="view-btn active" data-view="table">
                    <i class="fas fa-table"></i> Vue Tableau
                </button>
                <button class="view-btn" data-view="calendar">
                    <i class="fas fa-calendar-alt"></i> Vue Calendrier
                </button>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView">
            <div id="calendar"></div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section" id="tableSection">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterStatus">Statut</label>
                    <select id="filterStatus" class="form-control select2">
                        <option value="">Tous les statuts</option>
                        <option value="PENDING">En attente</option>
                        <option value="CONFIRMED">Confirmée</option>
                        <option value="CANCELLED">Annulée</option>
                        <option value="COMPLETED">Terminée</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterDateRange">Date</label>
                    <select id="filterDateRange" class="form-control select2">
                        <option value="">Toutes les dates</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="tomorrow">Demain</option>
                        <option value="this_week">Cette semaine</option>
                        <option value="next_week">Semaine prochaine</option>
                        <option value="this_month">Ce mois</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterUser">Client</label>
                    <select id="filterUser" class="form-control select2">
                        <option value="">Tous les clients</option>
                        <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.firstname + ' ' + user.lastname}"></option>
                    </select>
                </div>
                <div class="filter-group d-flex align-items-end">
                    <button class="btn btn-primary mr-2" id="applyFilters">
                        <i class="fas fa-filter mr-2"></i>Filtrer
                    </button>
                    <button class="btn btn-outline-secondary" id="resetFilters">
                        <i class="fas fa-redo mr-2"></i>Réinitialiser
                    </button>
                </div>
            </div>
        </div>

        <!-- Bookings Table -->
        <div class="dataTables_wrapper" id="tableView">
            <table id="bookingsTable" class="table table-hover" style="width:100%">
                <thead>
                <tr>
                    <th>Client</th>
                    <th>Titre</th>
                    <th>Date</th>
                    <th>Heure</th>
                    <th>Durée</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Montant</th>
                    <th>Créé le</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <!-- Données chargées via AJAX -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2026 Studio Photo Admin. Tous droits réservés. | Version 2.1.0</p>
    </footer>
</div>

<!-- Booking Modal (Add/Edit) -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Nouvelle Réservation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" th:action="@{/admin/bookings/save}" method="post">
                    <input type="hidden" id="bookingId" name="id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="clientId">Client *</label>
                                <select class="form-control select2" id="clientId" name="userId" style="width: 100%" required>
                                    <option value="">Sélectionner un client</option>
                                    <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.firstname + ' ' + user.lastname}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="bookingType">Type de réservation *</label>
                                <select class="form-control select2" id="bookingType" name="type" style="width: 100%" required>
                                    <option value="PHOTO_SESSION">Séance photo</option>
                                    <option value="EVENT">Événement</option>
                                    <option value="PORTRAIT">Portrait</option>
                                    <option value="PRODUCT">Produit</option>
                                    <option value="OTHER">Autre</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="title">Titre *</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="startDate">Date de début *</label>
                                <input type="datetime-local" class="form-control" id="startDate" name="startDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="endDate">Date de fin *</label>
                                <input type="datetime-local" class="form-control" id="endDate" name="endDate" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="amount">Montant (€)</label>
                                <input type="number" class="form-control" id="amount" name="amount" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="status">Statut *</label>
                                <select class="form-control select2" id="status" name="status" style="width: 100%" required>
                                    <option value="PENDING">En attente</option>
                                    <option value="CONFIRMED">Confirmée</option>
                                    <option value="CANCELLED">Annulée</option>
                                    <option value="COMPLETED">Terminée</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary" id="saveBookingBtn">
                            <i class="fas fa-save mr-2"></i>Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/locale/fr.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        // Initialize Select2
        $('.select2').select2({
            width: '100%',
            theme: 'bootstrap'
        });

        // Initialize FullCalendar
        $('#calendar').fullCalendar({
            locale: 'fr',
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            events: '/admin/bookings/api/calendar',
            eventClick: function(calEvent) {
                editBooking(calEvent.id);
            },
            dayClick: function(date) {
                $('#startDate').val(date.format('YYYY-MM-DDTHH:mm'));
                $('#endDate').val(date.add(1, 'hour').format('YYYY-MM-DDTHH:mm'));
                $('#bookingModal').modal('show');
            }
        });

        // Initialize DataTable
        var table = $('#bookingsTable').DataTable({
            language: {
                url: '/js/i18n/French.json'
            },
            dom: 'Bfrtip',
            buttons: [
                'copy', 'excel', 'pdf'
            ],
            processing: true,
            serverSide: true,
            ajax: {
                url: '/admin/bookings/api/datatable',
                type: 'GET',
                data: function(d) {
                    d.status = $('#filterStatus').val();
                    d.dateRange = $('#filterDateRange').val();
                    d.userId = $('#filterUser').val();
                }
            },
            columns: [
                {
                    data: null,
                    render: function(data, type, row) {
                        const initials = (row.user?.firstname?.[0] || '') + (row.user?.lastname?.[0] || '');
                        const name = row.user ? row.user.firstname + ' ' + row.user.lastname : 'Non assigné';
                        return `
                            <div class="customer-info">
                                <div class="customer-avatar">${initials}</div>
                                <div>
                                    <div class="font-weight-bold">${name}</div>
                                    <small class="text-muted">${row.user?.email || ''}</small>
                                </div>
                            </div>
                        `;
                    }
                },
                { data: 'title' },
                {
                    data: 'startTime',
                    render: function(data) {
                        return moment(data).format('DD/MM/YYYY');
                    }
                },
                {
                    data: null,
                    render: function(data) {
                        const start = moment(data.startTime).format('HH:mm');
                        const end = moment(data.endTime).format('HH:mm');
                        return `${start} - ${end}`;
                    }
                },
                {
                    data: null,
                    render: function(data) {
                        const duration = moment.duration(moment(data.endTime).diff(moment(data.startTime)));
                        return duration.hours() + 'h' + (duration.minutes() > 0 ? duration.minutes() + 'min' : '');
                    }
                },
                { data: 'type' },
                {
                    data: 'status',
                    render: function(data) {
                        const statusClass = 'badge-' + data.toLowerCase();
                        const statusText = {
                            'PENDING': 'En attente',
                            'CONFIRMED': 'Confirmée',
                            'CANCELLED': 'Annulée',
                            'COMPLETED': 'Terminée'
                        }[data] || data;
                        return `<span class="status-badge ${statusClass}">${statusText}</span>`;
                    }
                },
                {
                    data: 'amount',
                    render: function(data) {
                        return data ? data + ' €' : '-';
                    }
                },
                {
                    data: 'createdAt',
                    render: function(data) {
                        return data ? moment(data).fromNow() : '-';
                    }
                },
                {
                    data: null,
                    orderable: false,
                    render: function(data, type, row) {
                        return `
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-info edit-btn" data-id="${row.id}" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success confirm-btn" data-id="${row.id}" title="Confirmer" ${row.status === 'CONFIRMED' ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning cancel-btn" data-id="${row.id}" title="Annuler" ${row.status === 'CANCELLED' ? 'disabled' : ''}>
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${row.id}" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                }
            ],
            order: [2, 'desc'],
            pageLength: 25,
            responsive: true
        });

        // Helper functions
        function showLoading() {
            $('#loadingOverlay').fadeIn();
        }

        function hideLoading() {
            $('#loadingOverlay').fadeOut();
        }

        function loadStats() {
            showLoading();
            fetch('/admin/bookings/api/stats')
                .then(response => response.json())
                .then(stats => {
                    $('#totalBookings').text(stats.totalBookings || 0);
                    $('#pendingBookings').text(stats.pendingBookings || 0);
                    $('#confirmedBookings').text(stats.confirmedBookings || 0);
                    $('#todayBookings').text(stats.todayBookings || 0);
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    hideLoading();
                });
        }

        function editBooking(id) {
            showLoading();
            fetch(`/admin/bookings/api/${id}`)
                .then(response => response.json())
                .then(booking => {
                    $('#bookingId').val(booking.id);
                    $('#clientId').val(booking.user?.id).trigger('change');
                    $('#bookingType').val(booking.type).trigger('change');
                    $('#title').val(booking.title);
                    $('#startDate').val(moment(booking.startTime).format('YYYY-MM-DDTHH:mm'));
                    $('#endDate').val(moment(booking.endTime).format('YYYY-MM-DDTHH:mm'));
                    $('#amount').val(booking.amount || '');
                    $('#status').val(booking.status).trigger('change');
                    $('#notes').val(booking.notes || '');
                    $('#bookingModalLabel').text('Modifier Réservation');
                    $('#bookingModal').modal('show');
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error fetching booking:', error);
                    alert('Erreur lors du chargement de la réservation');
                    hideLoading();
                });
        }

        // User initials
        const userName = /*[[${#authentication.principal.firstname + ' ' + #authentication.principal.lastname}]]*/ 'Admin';
        const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
        $('#userInitials').text(initials);

        // View toggle
        $('.view-btn').click(function() {
            $('.view-btn').removeClass('active');
            $(this).addClass('active');
            const view = $(this).data('view');

            if (view === 'calendar') {
                $('#tableSection').hide();
                $('#tableView').hide();
                $('#calendarView').show();
                $('#calendar').fullCalendar('refetchEvents');
            } else {
                $('#tableSection').show();
                $('#tableView').show();
                $('#calendarView').hide();
            }
        });

        // Quick actions
        $('.quick-action-btn').click(function(e) {
            e.preventDefault();
            const status = $(this).data('status');
            const action = $(this).data('action');

            if (status) {
                $('#filterStatus').val(status).trigger('change');
                table.ajax.reload();
            } else if (action === 'calendar') {
                $('.view-btn[data-view="calendar"]').click();
            } else if (action === 'export') {
                table.button('.buttons-excel').trigger();
            }
        });

        // Filter functionality
        $('#applyFilters').click(function() {
            table.ajax.reload();
            loadStats();
        });

        $('#resetFilters').click(function() {
            $('#filterStatus').val('').trigger('change');
            $('#filterDateRange').val('').trigger('change');
            $('#filterUser').val('').trigger('change');
            table.ajax.reload();
            loadStats();
        });

        // Add Booking Button
        $('#addBookingBtn').click(function() {
            $('#bookingForm')[0].reset();
            $('#bookingId').val('');
            $('#bookingModalLabel').text('Nouvelle Réservation');
            $('.select2').trigger('change');

            // Set default times
            const now = moment();
            $('#startDate').val(now.format('YYYY-MM-DDTHH:mm'));
            $('#endDate').val(now.add(1, 'hour').format('YYYY-MM-DDTHH:mm'));
        });

        // Edit Booking
        $('#bookingsTable tbody').on('click', '.edit-btn', function() {
            const bookingId = $(this).data('id');
            editBooking(bookingId);
        });

        // Confirm Booking
        $('#bookingsTable tbody').on('click', '.confirm-btn', function() {
            const bookingId = $(this).data('id');
            Swal.fire({
                title: 'Confirmation',
                text: 'Êtes-vous sûr de vouloir confirmer cette réservation ?',
                icon: 'info',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Oui, confirmer !',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    fetch(`/admin/bookings/api/${bookingId}/confirm`, {
                        method: 'POST'
                    })
                    .then(response => {
                        if (response.ok) {
                            table.ajax.reload();
                            loadStats();
                            $('#calendar').fullCalendar('refetchEvents');
                            Swal.fire('Confirmé !', 'La réservation a été confirmée.', 'success');
                        } else {
                            Swal.fire('Erreur', 'Erreur lors de la confirmation de la réservation.', 'error');
                        }
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error confirming booking:', error);
                        Swal.fire('Erreur', 'Erreur lors de la confirmation de la réservation.', 'error');
                        hideLoading();
                    });
                }
            });
        });

        // Cancel Booking
        $('#bookingsTable tbody').on('click', '.cancel-btn', function() {
            const bookingId = $(this).data('id');
            Swal.fire({
                title: 'Confirmation',
                text: 'Êtes-vous sûr de vouloir annuler cette réservation ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Oui, annuler !',
                cancelButtonText: 'Retour'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    fetch(`/admin/bookings/api/${bookingId}/cancel`, {
                        method: 'POST'
                    })
                    .then(response => {
                        if (response.ok) {
                            table.ajax.reload();
                            loadStats();
                            $('#calendar').fullCalendar('refetchEvents');
                            Swal.fire('Annulé !', 'La réservation a été annulée.', 'success');
                        } else {
                            Swal.fire('Erreur', 'Erreur lors de l\'annulation de la réservation.', 'error');
                        }
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error cancelling booking:', error);
                        Swal.fire('Erreur', 'Erreur lors de l\'annulation de la réservation.', 'error');
                        hideLoading();
                    });
                }
            });
        });

        // Delete Booking
        $('#bookingsTable tbody').on('click', '.delete-btn', function() {
            const bookingId = $(this).data('id');
            Swal.fire({
                title: 'Êtes-vous sûr ?',
                text: "Cette action est irréversible !",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Oui, supprimer !',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    fetch(`/admin/bookings/api/${bookingId}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (response.ok) {
                            table.ajax.reload();
                            loadStats();
                            $('#calendar').fullCalendar('refetchEvents');
                            Swal.fire(
                                'Supprimé !',
                                'La réservation a été supprimée.',
                                'success'
                            );
                        } else {
                            Swal.fire(
                                'Erreur !',
                                'Impossible de supprimer la réservation.',
                                'error'
                            );
                        }
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error deleting booking:', error);
                        Swal.fire(
                            'Erreur !',
                            'Une erreur est survenue.',
                            'error'
                        );
                        hideLoading();
                    });
                }
            });
        });

        // Save Booking Form
        $('#bookingForm').submit(function(e) {
            e.preventDefault();

            const formData = {
                id: $('#bookingId').val() || null,
                userId: $('#clientId').val(),
                type: $('#bookingType').val(),
                title: $('#title').val(),
                startTime: $('#startDate').val(),
                endTime: $('#endDate').val(),
                amount: $('#amount').val() || null,
                status: $('#status').val(),
                notes: $('#notes').val()
            };

            const method = formData.id ? 'PUT' : 'POST';
            const url = formData.id ? `/admin/bookings/api/${formData.id}` : '/admin/bookings/api';

            showLoading();
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(err => Promise.reject(err));
                }
            })
            .then(() => {
                $('#bookingModal').modal('hide');
                table.ajax.reload();
                loadStats();
                $('#calendar').fullCalendar('refetchEvents');
                hideLoading();
                Swal.fire(
                    'Succès !',
                    formData.id ? 'Réservation mise à jour.' : 'Réservation créée.',
                    'success'
                );
            })
            .catch(error => {
                console.error('Error saving booking:', error);
                Swal.fire(
                    'Erreur !',
                    error.message || 'Une erreur est survenue.',
                    'error'
                );
                hideLoading();
            });
        });

        // Initial load
        loadStats();
    });
    /*]]>*/
</script>
</body>
</html>